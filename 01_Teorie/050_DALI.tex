\chap DALI

\rfc{050_DALI.tex - vypracovat DALI}

% \mnote{\inoval{DALI}}


% \medskip
% Vlastnosti DALI protokolu:
% \begitems
%     * Jednoduché zapojení řídících linek
%     * Řízení individuálních jednotek nebo skupin jednotek prostřednictvím adresování
%     * Současné ovládání všech jednotek prostřednictvím vysílání adres
%     * Jednoduchá struktura komunikace
%     * Možnost kontroly stavu jednotlivého nebo skupiny osvětlovacích zařízení včetně chyb, úrovní napájení atd.
%     * Vytváření vlastních scén osvětlení
%     * Logaritmické stmívání odpovídající citlivosti oka
%     * Větší funkčnost a~nižší náklady na systém ve srovnání se systémy 1-10V
% \enditems


\glref{DALI} (Digitální adresovatelné rozhraní pro osvětlení)
(jak je uvedeno \cite[dali_quick_start])
je standardizovaný protokol pro digitální komunikaci v systémech osvětlení.
Umožňuje obousměrnou výměnu dat mezi řídicími jednotkami a~elektronickými předřadníky světel
spolu s~dalšími zařízeními.

\medskip\noindent
Technické detaily:
\begitems
    *{\sbf Norma:} IEC 62386.
    *{\sbf Typ kabelu:} Dvoulinková sběrnice.
    *{\sbf Napájení:} Sběrnice slouží i pro napájení některých zařízení. Napětí se běžně pohybuje okolo
       16~V v klidovém stavu, ale během komunikace může kolísat.
    *{\sbf Komunikace:} Digitální, obousměrná.
    *{\sbf Typy příkazů:}
    \begitems\style o
        *{\sbf Ovládání:} Nastavení jasu, aktivace scén, vypnutí světel.
        *{\sbf Konfigurace:} Úprava délky stmívání, nastavení jasu ve scénách, přiřazení tlačítek ke skupinám.
        *{\sbf Dotazy:} Zjištění konfigurace světel, aktuálního jasu, hlášení poruch světel.
    \enditems
\enditems

%  ############################################################################################################
\sec Terminologie

Norma IEC 62386, která definuje protokol DALI, obsahuje řadu specifických pojmů. Níže je uveden popis vybraných z nich:

\begitems\style n
* {\sbf Řídicí jednotka} (Control Device):

    \begitems
    * Toto je obecný termín pro zařízení v systému DALI, které odesílá řídicí příkazy a~dotazy.
      Řídicí zařízení se dále dělí na dva typy:
        \begitems\style o
        * {\sbf Aplikační řadič} (Application Controller): Hlavní řídicí jednotka v systému DALI,
            která je zodpovědná za celkovou koordinaci osvětlení.
            Může jím být například tlačítkový panel, počítač nebo inteligentní systém budovy.
        * {\sbf Vstupní zařízení} (Input Device): Zařízení, které generuje uživatelské vstupy
            a~odesílá je do aplikačního řadiče.
            Typickým příkladem je tlačítko stmívání, pohybový senzor nebo senzor okolního světla.
        \enditems
    \enditems
* {\sbf Předřadník světelného zdroje} (Control Gear, Ballast):
    \begitems
        * Toto je elektronické zařízení, které reguluje napájení a~proud dodávaný do světelného zdroje.
            V~systému DALI může předřadník přijímat řídicí příkazy a~dotazy z~řídicího zařízení a~podle nich
            upravovat jas a~další parametry světelného zdroje.
    \enditems
\enditems


Pro sjednocení terminologie v oboru osvětlení se doporučuje navštívit webové
stránky \url{https://www.electropedia.org} a~prostudovat si sekci věnovanou osvětlení (Lighting).


Řídící jednotka, předřadník a~napájecí zdroje sběrnice jsou
tři základní typy zařízení, které se vyskytují na sběrnici v systému DALI.

\medskip \clabel[dalicek]{Terminologie}
\picw=12cm \cinspic 03_Obrazky/dalicek.png
\caption/f Terminologie

%  ############################################################################################################
% \sec DALI verze 2 a~DALI verze 1
\sec Varianty protokolu

V současné době rozlišujeme již několik verzi protokolu  DALI jako například
{\sbf DALI} (verze~1), {\sbf DALI-2}, {\sbf D4i} a~{\sbf DALI+}.
Z hlediska zaměření diplomové práce se budeme zabývat protokolem DALI-2,
který rozšiřuje původní verzi DALI v1.

Hlavním problémem původní verze DALI (IEC 62386) byla nedostatečná specifikace chování
řídicích jednotek. Norma definovala pouze fungování předřadníků \cite[iec102],
čímž dala výrobcům řídicích jednotek značnou volnost v implementaci.
To vedlo k nekompatibilitě a~nemožnosti vzájemného propojení zařízení od různých dodavatelů.

Dalším problémem bylo omezení umístění vstupních zařízení, jako jsou tlačítka a~senzory.
Norma DALI v1 neumožňovala připojení těchto zařízení přímo na sběrnici.
Musely být připojeny k řídicí jednotce, která pak s nimi komunikovala
a předávala informace předřadníkům.
Nebo se volilo řešení s použitím další sběrnice, jako KNX\cite[isoknx], Modbus\cite[modbus] nebo jiné
To zvyšovalo složitost a~náklady na instalaci a~omezovalo flexibilitu systému.

DALI-2, uvedená v roce 2017, tento problém napravuje. Norma rozšiřuje specifikaci a~zahrnuje
i~chování řídicích jednotek \cite[iec103]. Díky tomu jsou všechna zařízení v DALI-2 systému vzájemně kompatibilní.
Kromě toho zavádí DALI-2 certifikační program, který zaručuje, že všechna certifikovaná zařízení splňují normu IEC 62386.

Možnost použití bezdrátové komunikace a~IP protokolu byla zavedena až v~normě DALI+.

\medskip
Aby se zachovala kompatibilita se staršími systémy, rozlišuje DALI-2 dva typy řídicích jednotek:
\begitems
    *{\sbf Single master:} Tyto jednotky jsou kompatibilní s DALI v1 a~fungují jako hlavní řídicí prvek v systému.
    *{\sbf Multi master:} Modernější řídicí jednotky, které umožňují pokročilejší funkce a~flexibilitu v DALI-2 systémech.
\enditems

Multi master DALI-2 má striktnější pravidla pro komunikaci. Jedním z příkladů je časování půl bitů:
\begitems
    *{\sbf Single master:} 366,7 až 466,7 µs (\cite[iec101], kapitola 8.1.1)
    *{\sbf Multi master:} 400,0 až 433,3 µs (\cite[iec101], kapitola 8.3.1)
\enditems

Single master má povolenou odchylku až 10\% od nominální hodnoty doby půl bitu 416,7 µs,
zatímco multi master pouze 5\%.
Tyto drobné rozdíly v časování můžou u některých starších zařízení způsobovat problémy
s kompatibilitou a~vylučovat je z provozu v multi master systémech.

V DALI systémech s více řídicími jednotkami (multi-master) může docházet
na sběrnici ke kolizím kvůli paralelní komunikaci.
Tyto řídící jednotky musí být schopny detekovat kolize a~řešit je.
V single master systému je pouze jedna řídicí jednotka, která odesílá pokyny na sběrnici.
Nemusí přijímat data, protože je jediným komunikujícím zařízením.


Multi-master DALI zařízení jsou pokročilejší a~flexibilnější než single-master.
Díky obousměrné komunikaci a~detekci kolizí umožňuje multi-master DALI implementaci
složitějších funkcí a~konfigurací v osvětlovacích systémech. Single-master DALI zařízení
jsou vhodné pro základní aplikace, kde je potřeba ovládat osvětlení z jednoho centrálního
bodu, všechny vstupy jsou v dosahu řídící jednotky a~není zapotřebí pokročilých funkcí.
Příklady použití single-master a~multi-master systémů jsou uvedeny v příloze A.2 normy
IEC 62386-101 \cite[iec101].


%  ############################################################################################################
\sec Topologie sběrnice

Připojování zařízení v systému DALI může být provedeno několika způsoby\cite[iec101] (obr. \ref[topolgie]):
\begitems
    * {\sbf Hvězdicová topologie:} Kabely od všech zařízení jsou vedeny centrálně k jednomu napájecímu zdroji.
    * {\sbf Seriová topologie:} Zařízení jsou propojena v řadě, kdy z jednoho zařízení vede kabel k dalšímu.
    * {\sbf Kombinace obou:} Můžete kombinovat hvězdicovou a~seriovou topologii pro větší flexibilitu.
\enditems

\noindent
Nedoporučuje se:
\begitems
    *{\sbf Kruhová topologie:} Připojování zařízení do kruhu {\sbf není} v DALI povoleno.
\enditems

\medskip \clabel[topolgie]{Topologie sběrnice DALI}
\picw=8cm \cinspic 03_Obrazky/g38.png
\caption/f Topologie sběrnice DALI
\medskip


Pro kabeláž se používají dva vodiče, které tvoří sběrnici DALI,
a musí být umístěny ve stejném kabelu nebo kabelovém svazku, aby se minimalizovalo
nežádoucí ovlivňování jinými signály (viz obr. \ref[kabel] ).
Maximální vzdálenost mezi jednotkami může být až 300 metrů v~závislosti na použitém kabelu
(tabulka A.1 \cite[iec101]) a~okolním rušení.
Maximální povolený úbytek napětí na sběrnici je 2 V.


\medskip \clabel[kabel]{Kabel DALI}
\picw=10cm \cinspic 03_Obrazky/kabel.png
\caption/f Ukázka použitého kabelu pro sběrnici DALI
\medskip

% Protokol DALI omezuje systém na maximálně šedesát čtyři jednotky, maximálně šestnáct skupin a~maximálně šestnáct scén.
% Každá z~těchto šedesáti čtyř jednotek je přiřazena krátká adresa, která je uložena v~zapalovači.
% Každá jednotlivá jednotka může také obsahovat číslo přiřazení ke skupině, hodnoty osvětlovací scény,
% časy zeslabování a~úrovně nouzového osvětlení. Krátké adresy mohou být během výroby programovány výrobcem
% do zapalovače, nebo mohou být během instalace programovány designérem. Skupinové adresy jsou obvykle
% přiděleny softwarově během instalace, což umožňuje budoucí změny ve struktuře skupin.

% DALI má strukturu drátů volného tvaru, takže jsou povoleny daisy-chained, lineární, hvězdicové nebo smíšené
% struktury drátů, s~výjimkou kruhových struktur spojení. DALI stanoví maximální vzdálenost 300 metrů mezi
% jednotkami a~umožňuje maximální úbytek napětí 2 voltů přes propojovací dráty od napájecího zdroje rozhraní
% k~jednotlivým jednotkám. Sběrnice DALI pracuje s~baudovou rychlostí 1200 bps, takže není potřeba speciální
% kabely nebo dráty.


%  ############################################################################################################
\sec Elektrická specifikace

Standard IEC 62386\cite[iec101] specifikuje elektrické parametry sběrnice v systému DALI. Nejdůležitější z nich jsou:
\begitems
    *{\sbf Polarita:} Rozhraní je nezávislé na polaritě napětí s výjimkou případů, kdy je napájecí zdroj integrován do sběrnice.
    *{\sbf Značení:} Rozhraní by mělo být označeno "da" nebo "DA" pro datové vodiče.
    *{\sbf Napájení:} Napájecí napětí by mělo být mezi 12,0 a~20,5~V, typicky 16~V.
    *{\sbf Napětí:} Rozhraní má dvě úrovně napětí: nízkou a~vysokou.
    \begitems\style o
        * Pro přijímač je nízká úroveň (0 až 6,5~V), vysoká (9,5 až 22,5~V) (tab.8 \cite[iec101]).
        * Pro vysílač je nízká úroveň (0 až 4,5~V), vysoká (10 až 22,5~V) (tab.9 \cite[iec101]).
    \enditems
    *{\sbf Odběr:} Každé zařízení připojené k~sběrnici by mělo odebírat maximálně 2~mA.
    *{\sbf Proud:} Maximální proud na sběrnici je 250~mA.
    *{\sbf Aktivní stav:} Při nízkém stavu vysílače a~odběru 250 mA nesmí výstupní napětí být vyšší než 4,5~V.
    *{\sbf Hrana signálu:} Náběžná a~sestupní hrana signálu, by neměla být kratší než 3 µs, kvůli minimalizaci \glref{EMI} rušení.
\enditems


%  ############################################################################################################
\sec Přenosový protokol

Přenosový protokol DALI využívá k přenosu informace hrany signálu (viz obr. \ref[kodovani])
s~pevně stanovenou přenosovou rychlostí 1200 bps.
Logické jedničce odpovídá vzestupná hrana signálu a~nule odpovídá sestupná hrana signálu.

Komunikace po sběrnici je sice asynchronní, tedy bez synchronizačního signálu,
ale každá hrana signálu slouží současně k synchronizaci komunikace, což znamená,
že přijímací strana vždy měří délku pulzu od poslední hrany.
Tento typ kódování je znám jako protokol Manchester.


\medskip \clabel[kodovani]{Kodování bitů v protokolu DALI}
\picw=8cm \cinspic 03_Obrazky/logika.png
\vbox{\caption/f Kodování bitů v protokolu DALI}
\vbox{\centerline{(\url{www.researchgate.net/figure/DALI-Electrical-Specification_fig2_344319530})}}
% https://www.researchgate.net/figure/DALI-Electrical-Specification_fig2_344319530
\medskip

\noindent
Na sběrnici rozlišujeme:
\begitems
* {\sbf Klidový stav:} Rozhraní je v~klidovém stavu, pokud je napětí na vysoké úrovni.
* {\sbf Aktivní stav:} Rozhraní je v~aktivním stavu, pokud je napětí na nízké úrovni.
\enditems

\noindent
Kromě logických nul a~jedniček obsahuje každý datový rámec start a~stop bity, které slouží k synchronizaci komunikace.:
\begitems
* {\sbf Start bit:} Jednička, která označuje začátek rámce.
* {\sbf Stop bit:} Klidový stav, který trvá specifikovanou dobu a~označuje konec rámce.
\enditems

\noindent
Datový rámec obsahuje:
\begitems
* {\sbf Start bit:}
* {\sbf Data:} Data o délce 1 až 32 bitů.
* {\sbf Stop bit:}
\enditems


%  ############################################################################################################
\sec Typy datových paketů


Datové pakety protokolu DALI se dělí na:
\begitems
    *{\sbf Standardní:} Tyto pakety mohou mít délku 8, 16, 24 nebo 32 bitů a~jsou používány pro základní funkce protokolu DALI.
    *{\sbf Rezervované:} Tyto pakety mají délku 20 bitů, jsou vyhrazeny a~nesmějí se používat.
    *{\sbf Privátní:} Tyto pakety definují výrobci zařízení a~slouží k rozšíření funkcí protokolu DALI o specifické funkce daného výrobce.
        Mohou mít libovolnou délku kromě výše uvedených. Nicméně se nedoporučuje používat pakety o délce 8 až 15 bitů.
\enditems

\noindent
Datový paket {\sbf 8 bitů}:
\begitems
 * tento datový rámec slouží k odesílání odpovědí na zprávy řídících a~vstupních jednotek,
 * norma IEC 62386 \cite[iec101], \cite[iec102] a~\cite[iec103].
\enditems


\noindent
Datový paket {\sbf16 bitů}:
\begitems
 * tento datový rámec slouží k odesílání zpráv předřadníkům,
 * norma IEC 62386-102\cite[iec102].
\enditems

\noindent
Datový paket {\sbf 24 bitů}:
\begitems
 * tento datový rámec slouží k odesílání zpráv řídících a~vstupních jednotek,
 * norma IEC 62386-103\cite[iec103].
\enditems

\noindent
Datový paket {\sbf 32 bitů}:
\begitems
 * tento datový rámec slouží k aktualizaci firmwaru řídících jednotek a~předřadníků,
 * norma IEC 62386-105\cite[iec105].
\enditems



%  ############################################################################################################
\sec Adresy, skupiny a~scény

Na sběrnici DALI mohou být zařízení identifikována pomocí adres a~skupin.
Celkový počet adres na jedné sběrnici je 64 pro předřadníky a~64 pro řídící jednotky, celkem 128 zařízení.

Existuje 16 skupin pro předřadníky; každý předřadník může být členem libovolné kombinace těchto 16 skupin.
Pro ovládací zařízení existuje 32 skupin; každé ovládací zařízení může být členem libovolné kombinace těchto 32 skupin.
Existuje 32 skupin pro vstupních jednotky (jako jsou jednotlivá tlačítka);
každé může být členem až 3 z těchto skupin \cite[dali_quick_start].

Některé zařízení mohou obsluhovat více světel, pak mohou používat více adres. Taková zařízení
označujeme jako zařízení s logickými jednotkami \cite[dali_quick_start].


Obecně je možné adresovat zařízení pomocí adresy v rozsahu 0 až 63, tzv krátká adresa,
pomocí dlouhé adresy 24 bitů, pomocí skupin a~pomocí broadcastů.

Broadcasty jsou zprávy, které jsou určeny všem zařízením na sběrnici, nebo
pouze zařízením bez přiřazené krátké adresy.

Skupiny slouží k ovládání více světel najednou, a~to těch které jsou zařazeny do dané skupiny.

Naproti tomu scény slouží k uložení a~následnému vyvolání konkrétního nastavení světel.
Celkově může být uloženo až 16 scén, které mohou obsahovat nastavení jasu, barvy a~další parametry světel.


% \sec Postup práce se sběrnicí
\sec Inicializace zařízení

V další části popíšeme postup práce se zařízeními na sběrnici DALI, který pak byl aplikován v našem projektu.

Použitá sběrnice obsahovala jednu řídící jednotku a~několik předřadníků. Postup činnosti byl následující:

\begitems
    * {Nastavení operačního modu.}
    * {Generování dlouhých adres.}
    * {Přiřazení krátkých adres.}
    * {Identifikace zařízení.}
    * {Přiřazení do skupin.}
    * {Nastavení jasu scén.}
\enditems

\medskip \noindent
{\sbf Nastavení operačního modu}

Zařízení DALI mohou pracovat v různých operačních režimech, které určují jejich chování.
Operační mód 0x00 je standardní režim, ve kterém zařízení reagují na zprávy z~řídící jednotky
podle normy IEC 62386-102\cite[iec102].

Ve všech operačních módech, musí zařízeni interpretovat požadavek na změny módu a~provést ho.
Přepnutí provedeme pomocí broadcast zprávy SET OPERATING MODE, proto není nutné znát adresy zařízení.

\medskip \noindent
Operační módy:
\begitems
    * Operační mód {\sbf 0x00:} Standardní režim.
    * Operační mód {\sbf 0x01 -- 0x7F:} Rezervováno.
    * Operační mód {\sbf 0x80 -- 0XFF:} Specifické režimy výrobce.
\enditems

Pozn: Před změnou operačního módu je dobré si ověřit, které režimy podporuje dané zařízení
aby bylo možné se do nich vrátit. Námi použité předřadníky byly schopny pracovat v režimu 0x00 a~0x80.

\medskip \noindent
{\sbf Generování dlouhých adres}

Dalším krokem k identifikaci jednotlivých světel je generování dlouhých adres.
Je to mezikrok, který snižuje riziko kolizí při přiřazování krátkých adres.

Před dalším postupem se musí zařízení přepnout do inicializačního režimu příkazem INITIALISE.
Pak se pošle požadavek na vygenerování dlouhých adres pomocí broadcast zprávy RANDOMIZE.
Po tomto požadavku si všechna zařízení na sběrnici vygenerují náhodnou dlouhou adresu o délce 24 bitů.


\medskip \noindent
{\sbf Přiřazení krátkých adres}

Krátká adresa se každému zařízení na sběrnici DALI přiřazuje podle postupu popsaného
v příloze A.1 \cite[iec102]. Postup zahrnuje následující kroky:

Postup nastavení krátkých adres:
\begitems
    * Přepnutí do inicializačního režimu se provede příkazem INITIALISE.
    * Nastavení dlouhé adresy pro vyhledávání nejmenší adresy, příkazy SEARCHADDRH, SEARCHADDRM, SEARCHADDRL.
    * Dotazem COMPARE se zjistí jestli mají nějaká zařízení adresu menší rovnou nastavené SEARCHADDR.
    * Postup se opakuje až najdeme jediné zařízení s adresou rovnou SEARCHADDR.
    * Tomuto zařízení se přiřadí krátké adresy příkazem PROGRAM SHORT ADDRESS.
    * Předřadník se vyloučí z dalšího hledání nejnižší adresy příkazem WITHDRAW.
    * Proces se opakuje pro další zařízení.
    * Inicializační režim se ukončí příkazem TERMINATE.
\enditems

Vyhledávaní nejnižší adresy se provádí binárním dělením intervalu možných adres. Počáteční adresa je
pro $2^{24}$ adres půlka intervalu tedy $2^{23}$, pak se interval dělí na poloviny až se najde hodnota pod kterou už
žádné zařízení není. Tato hodnota je nejnižší adresa na sběrnici. Na dotaz COMPARE odpovídají pouze
zařízení, jejichž dlouhá adresa je menší nebo rovna hodnotě SEARCHADDR. Cyklus se opakuje maximálně 24 krát,
pro jedno zařízení.

Proces končí přiřazením krátkých adres všem zařízením v intervalu 0 až N, kde N je počet zařízení na sběrnici.

Pozn: Je možné přiřadit krátkou adresu i přímo, pokud víme, že na sběrnici máme pouze jedno zařízení.
Použijeme příkaz SET SHORT ADDRESS(broadcast).

\medskip \noindent
{\sbf Identifikace zařízení}

Pokud jsou u všech zařízení na sběrnici DALI nastaveny krátké adresy, lze provést jejich identifikaci.
K identifikaci se používá příkaz IDENTIFY DEVICE.
Po odeslání příkazu IDENTIFY DEVICE vybrané zařízení zareaguje blikáním po dobu 10 sekund.
Tímto způsobem lze identifikovat jednotlivá zařízení na sběrnici.


Kromě příkazu IDENTIFY DEVICE je možné používat i další příkazy pro identifikaci zařízení DALI.
Mezi příklady patří vypnutí zařízení (příkaz OFF), nastavení maximálního jasu (příkaz RECALL MAX LEVEL)
a další.

Pokud uživateli nevyhovují aktuálně nastavené krátké adresy, lze je změnit.
K tomuto účelu slouží příkaz PROGRAM SHORT ADDRESS.


\medskip \noindent
{\sbf Přiřazení do skupin}

% Nedříve si naplánujeme, jaké skupiny budeme potřebovat a~jaké zařízení do nich zařadíme.
% Například skupina 0 může obsahovat všechna světla v místnosti, skupina 1 přímá světla,
% skupina 2 nepřímá světla a~tak dále.

% Pak přiřadíme světla do skupin pomocí příkazů ADD TO GROUP nebo REMOVE FROM GROUP.

% Poté můžeme ovládat všechna světla v dané skupině najednou. Můžeme provést identifikaci skupin
% jako v předchozím kroku, příkaz IDENTIFY DEVICE.




Před samotným přiřazením zařízení do skupin je nutné naplánovat jejich strukturu. To zahrnuje:
\begitems
    * Určení požadovaných skupin a jejich funkcí
    (např. skupina 0 - osvětlení celé místnosti, skupina 1 - přímé osvětlení, skupina 2 - nepřímé osvětlení atd.).
    * Výběr zařízení, která budou do jednotlivých skupin zařazena.
\enditems


Po naplánování skupin se zařízení do nich přiřadí pomocí příkazů
přidat zařízení do vybrané skupiny (příkaz ADD TO GROUP),
odstranit zařízení z vybrané skupiny (příkaz REMOVE FROM GROUP).

\noindent
Po přiřazení zařízení do skupin je možné je ovládat najednou. To umožňuje:
\begitems \style o
    * Společné zapnutí/vypnutí všech světel ve skupině.
    * Nastavení stejného jasu pro všechna světla ve skupině.
    * Vytváření světelných scén s definovanými úrovněmi jasu pro různé skupiny.
\enditems

\medskip \noindent
{\sbf Nastavení jasu scén}


Scény v DALI slouží k ukládání a vyvolávání předdefinovaných nastavení osvětlení.
Na rozdíl od skupin, které slouží k rozdělení světel do kategorií, scény uchovávají
kompletní konfiguraci osvětlení pro daný účel (jas, barva, zapnutí/vypnutí).
To umožňuje uživateli snadno přepínat mezi různými světelnými režimy bez nutnosti
manuálního nastavování jednotlivých parametrů.


Prvním krokem při práci se scénami je jejich naplánování.
Určení požadovaných scén a jejich funkcí (např. scéna 1 - přednáška, scéna 2 - písemka atd.).
Definování nastavení osvětlení pro každou scénu (jas pro různé skupiny světel, barva, zapnutí/vypnutí).

Scény se pak nastaví pomocí příkazu SET SCENE(group, value). Pokud světlo v dané scéně má výt vypnuté
použije se příkaz REMOVE FROM SCENE.

Aktivace scény se provede příkazem GO TO SCENE(broadcast). Tento příkaz nastaví všechna
světla ve vybrané skupině na hodnoty uložené v dané scéně.


%  ############################################################################################################
% \sec Komunikace na sběrnici
% Rámcům DALI (datovým paketům) se vytváří pomocí Manchester (bi-fázové) kódování, což se děje pomocí hardwaru UART.
% Kód Manchester je digitální kódovací formát, ve kterém logická '1' reprezentuje nárůstový přechod,
% který se vyskytuje během doby jednoho bitu, zatímco logická '0' reprezentuje poklesový přechod během
% doby jednoho bitu (viz obrázek níže). Startovací a~stopovací bity jsou kódovány jako logická '1'.
% \medskip
% Rámců jsou přenášeny s~baudovou rychlostí 1200 bps a~každý rámec je vždy odeslán s~nejvýznamnějším bitem (MSb) první.
% Protože baudová rychlost je 1200 bps, trvá každé období bitu 833,33 µs a~každé poloviční období bitu trvá 416,67 µs.
% Časy polovičního období jsou důležité, protože Manchesterovo kódování vyžaduje dva přechody bitů pro každý logický datový bit.
% Přední rámec je datový paket přenášený řídícím zařízením na řídicí zařízení nebo vstupní zařízení.
% Přední rámec DALI 1.0 obsahuje Startovací bit, následovaný bytovou adresou, jedním datovým bytem a~dvěma Stopovacími bity.
% \medskip
% Přední rámec DALI 2.0 obsahuje Startovací bit, následovaný bytovou adresou, až dvěma datovými byty a~podmínkou Stop (viz obrázek 2).
% Přední 24bitový rámec DALI 2.0, včetně Startovacího a~Stopovacího bitu, trvá 23,2 ms, nebo přibližně 56 polovičních období bitů,
% zatímco 16bitový rámec trvá 16,2 ms, nebo 39 polovičních období bitů. Jakmile řídící zařízení dokončí přenos rámce,
% musí řídící zařízení začít přenášet zpětný rámec nejdříve 5,5 ms (přibližně 14 polovičních období bitů)
% a~nejpozději 10,5 ms (přibližně 25 polovičních období). Jakmile byl zpětný rámec přijat v~plném rozsahu,
% musí řídící zařízení počkat minimálně 2,4 ms (přibližně šest polovičních období) před odesláním dalšího
% předního rámce (viz obrázek 3).
% Zpětný rámec je odpovědní paket přenášený z~řídícího zařízení na řídící zařízení. Zpětný rámec se skládá
% ze Startovacího bitu, jednoho datového bytu a~podmínky Stop (viz obrázek níže). Zpětný rámec, včetně Startovacího a
% Stopovacího bitu, trvá 9,95 ms (přibližně 24 polovičních období bitů). Datový byte může mít libovolnou hodnotu,
% v~závislosti na příkazu, který byl vydán řídícím zařízením. Pokud je datový byte zpětného rámce 0xFF,
% je odpověď považována za "ano". Pokud se očekává odpověď a~sběrnice zůstane v~klidovém stavu, je odpověď považována za "ne".
% \medskip
% https://onlinedocs.microchip.com/pr/GUID-0CDBB4BA-5972-4F58-98B2-3F0408F3E10B-en-US-1/index.html?GUID-1BB46A02-D54C-415B-9487-617FD3AA8BC9
% \medskip


%  ############################################################################################################
% \sec Popis příkazů

% \begitems \style o
% * off - Okamžité vypnutí světel
% * set max level - Nastavení maximální hodnoty jasu.
% * set min level - Nastavení minimální hodnoty jasu.
% * Recall max level
% * Recall min level
% * set system failure level - Nastavení jasu při výpadku řidící jednotky.
% * set power on level - Nastavení jasu při zapnutí proudu.
% * set fade time - Nastavení času prolínání.
% * set fade rate - Nastavení rychlosti prolínání.
% * set short adress - Nastavení krátké adresy pro jednotlivé světelná zařízení.
% * set scene - Nastavení světelné scény.
% * go to scene - Přechod mezi jednotlivými scénami.
% * identify device - Identifikace jednotlivých zařízení - světlené zařízení se rozbliká po dobu 10s.
% * add to group - Přidání světelného zařízení do skupin.
% * remove from group - Odstranění světelné zařízení ze skupiny.
% * set operating mode - Nastavení operačního módu.
% \enditems
% \medskip


\sec Příkazy

\medskip \noindent
{\sbf Proměnné DRT0, DRT1, DRT2}

Pro pochopení ovládání předřadníků DALI je důležité znát princip odesílání příkazů.
Některé příkazy, jako je nastavení jasu, jsou vícekrokové.
% To znamená, že před odesláním samotného příkazu je nutné v každém předřadníku nastavit specifickou proměnnou.

\medskip \noindent
Příklad nastavení maximální úrovně jasu:
\begitems
    * {\sbf DTR0:} Nastavení proměnné pro další krok. Tento krok se provádí najednou pro všechna zařízení.
    * {\sbf SET MAX LEVEL(device):} Nastavení maximální úrovně jasu pro vybraná zařízení.
\enditems

Před odesláním příkazu SET MAX LEVEL je nutné nastavit proměnnou DTR0 na požadovanou hodnotu jasu.
Důvodem je omezení protokolu na dvoubajtové zprávy, kterými nelze v jednom kroku poslat všechny potřebné informace.

\medskip \noindent
{\sbf Adresovací byte}

Adresovací byte je často první byte v datovém rámci a obsahuje informace
o adrese zařízení komu je zpráva určena.

\medskip \noindent
Může mít binární tvar (viz 7.2.1 \cite[iec102]):
\begitems
* {\tt 0AAA AAAx} - krátká adresa, kde A je adresa zařízení.
* {\tt 100G GGGx} - skupina, kde G je číslo skupiny.
* {\tt 1111 110x} - broadcast, zpráva je určena zařízením bez krátké adresy.
* {\tt 1111 111x} - broadcast, zpráva je určena všem zařízením.
\enditems

Pokud  x je "1", jedná se o běžný příkaz,
pokud je "0", jedná se o příkaz pro přímé ovládání jasu světel \glref{DAPC}.



\medskip \noindent
{\sbf Přehled příkazů protokolu DALI}


Příkazy protokolu DALI jsou rozděleny do několika skupin podle jejich funkce.
Omezíme se pouze na přehled některých příkazů pro ovládání předřadníků světel,
plný seznam je uveden v normě \cite[iec102] v kapitole 11.

\begitems
    * {\sbf Ovládání jasu:}
    \begitems \style o
        * {\sbf OFF:} Vypnutí světel.
        * {\sbf RECALL MAX LEVEL:} Nastavení jasu na maximální hodnotu.
        * {\sbf RECALL MIN LEVEL:} Nastavení jasu na minimální hodnotu.
        * {\sbf SET MAX LEVEL:} Nastavení maximální hodnoty jasu.
        * {\sbf SET MIN LEVEL:} Nastavení minimální hodnoty jasu.
        * {\sbf SET SYSTEM FAILURE LEVEL:} Nastavení jasu při výpadku řídící jednotky.
        * {\sbf SET POWER ON LEVEL:} Nastavení jasu při zapnutí proudu.
    \enditems

    * {\sbf Prolínání:}
    \begitems \style o
        * {\sbf UP:} Zvýšení jasu.
        * {\sbf DOWN:} Snížení jasu.
        * {\sbf STEP UP:} Zvýšení jasu o krok.
        * {\sbf STEP DOWN:} Snížení jasu o krok.
        * {\sbf SET FADE TIME:} Nastavení času prolínání.
        * {\sbf SET FADE RATE:} Nastavení rychlosti prolínání.
    \enditems

    * {\sbf Adresování:}
    \begitems \style o
        * {\sbf SET SHORT ADDRESS:} Nastavení krátké adresy pro jednotlivá světla.
    \enditems

    * {\sbf Scény:}
    \begitems \style o
        * {\sbf GO TO SCENE:} Přechod mezi jednotlivými scénami.
        * {\sbf SET SCENE:} Nastavení světelné scény.
        * {\sbf REMOVE FROM SCENE:} Odstranění světla ze scény.
    \enditems

    * {\sbf Identifikace:}
    \begitems \style o
        * {\sbf IDENTIFY DEVICE:} Identifikace jednotlivých zařízení - světlo se rozbliká po dobu 10~s.
    \enditems

    * {\sbf Skupiny:}
    \begitems \style o
        * {\sbf ADD TO GROUP:} Přidání světelného zařízení do skupin.
        * {\sbf REMOVE FROM GROUP:} Odstranění světelného zařízení ze skupiny.
    \enditems

    * {\sbf Operační mód:}
    \begitems \style o
        * {\sbf SET OPERATING MODE:} Nastavení operačního módu.
    \enditems
\enditems



%  ############################################################################################################
% \sec Shrnutí parametrů DALI protokolu

% \medskip \clabel[p]{Parametry}
% \picw=12cm \cinspic 03_Obrazky/specifikace.png
% \caption/f Parametry
% \medskip

%  ############################################################################################################
\sec Popis Hardwaru

D1: Usměrňovací můstek, aby nezáleželo na polaritě připojení ke sběrnici.

OP1: Přijímací optočlen.

OP2: Vysílací optočlen.

SW: Spínač používaný k vysílání. Spínač musí být schopen sepnout 250 mA a v případě DALI-2 navíc přežít přímé připojení
k rozvodné síti (230 V). Starší konstrukce obvykle používají bipolární tranzistor zapojený do Darlingtonova zapojení
s fototranzistorem v optočlenu, novější MOSFET buzený obvodem, který je schopen udržet ovládací napětí po dobu zkratu.

R1: Rezistor omezující proud procházející skrz LED vysílacího optočlenu.

R2: Rezistor omezující proud procházející skrz fototranzistor přijímacího optočlenu.

R3: Rezistor omezující proud procházející skrz LED přijímacího optočlenu.
Lepší je na tomto místě použít proudový stabilizátor.

D2: Zenerova dioda zajišťující, aby přijímací optočlen nesvítil při napětí,
které má být považováno za nízkou úroveň. Na rozhodovací úroveň má vliv i úbytek na LED optočlenu, R3, R2 a CTR optočlenu.

ST1: Proudový stabilizátor omezující proud procházející LED přijímacího optočlenu.
V DALI-2 musí vydržet trvalé připojení k rozvodné síti (230 V). Zpravidla se jedná o nejjednodušší stabilizátor
ze dvou tranzistorů a dvou rezistorů.


\medskip \clabel[schematic]{Schéma hardwaru}
\picw=12cm \cinspic 03_Obrazky/schematic.png
\caption/f Schéma DALI
\medskip

\medskip \clabel[schematic2]{Schéma hardwaru 2}
\picw=12cm \cinspic 03_Obrazky/schematic2.png
\caption/f Schéma DALI 2
\medskip


