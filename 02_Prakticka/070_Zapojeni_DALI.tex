\chap Návrh světelného ovládání

% \mnote{\inoval{DALI zapojeni}}

Poslední fáze praktické části se zaměřila na optimalizaci stávajícího světelného
ovládání s cílem zjednodušit jeho obsluhu a~zvýšit uživatelský komfort.

\medskip \clabel[ovl0]{Aktuální ovládání}
\picw=10cm \cinspic 03_Obrazky/ovladani.jpg
\caption/f Aktuální ovládání
\medskip

% Aktuálně je ovládání světel nastaveno tak, že každá řada světel reaguje na krátké nebo dlouhé stisknutí tlačítka.
% Krátké stisknutí způsobí buď zapnutí nebo vypnutí světel, zatímco dlouhé stisknutí slouží k~postupnému zvyšování
% nebo snižování jasu.
% Toto ovládání není ideální, proto bylo navrženo změnit ovládání na 4 tlačítka, spolu s dvěma tlačítky pro regulaci jasu.
% Tímto způsobem chceme vytvořit pohodlnější a~intuitivnější ovládání.

\sec Analýza stávajícího ovládání

V současnosti je systém vybaven 12 tlačítky, které slouží k~ovládání
jednotlivých řad světel (viz obrázek \ref[ovl0]).
Každé tlačítko ovládá jednu řadu světel a~reaguje na dva typy stisknutí:
\begitems
    * {\sbf Krátké stisknutí:} Zapíná nebo vypíná příslušné světelné zařízení.
    * {\sbf Dlouhé stisknutí:} Postupně zvyšuje nebo snižuje jas daného světelného zařízení.
\enditems

\medskip\noindent
Toto ovládání má svá omezení:
\begitems
    * {\sbf Složitost:} Velký počet tlačítek a~dva typy stisknutí pro každé tlačítko mohou být pro uživatele matoucí a~obtížně zapamatovatelné.
    * {\sbf Neintuitivní ovládání:} Postupné zvyšování a~snižování jasu dlouhým stisknutím tlačítka nemusí být pro uživatele intuitivní a~pohodlné.
\enditems


\sec Návrh optimalizovaného ovládání

Navrhované optimalizované řešení snižuje počet tlačítek na 4 a~doplňuje
je o~2~tlačítka pro regulaci jasu (viz obrázek \ref[tlac]).

% Nový navržený ovládací panel snižuje počet tlačítek na 4 a rozšiřuje je o 2 nová tlačítka
% pro nastavení jasu.



\medskip \clabel[tlac]{Tlačítka}
\picw=10cm \cinspic 03_Obrazky/Ovladani/tlacitka.png
\caption/f Tlačítka
\medskip


\noindent
Tlačítka jsou rozdělena do dvou sekcí:

\begitems
    * {\sbf Ovládání zapnutí/vypnutí:}
    \begitems \style o
        * {\sbf tlačítko 1:} slouží k~vypnutí všech světel,
        * {\sbf tlačítka 2--4:} slouží k~zapínání jednotlivých světelných scén.
    \enditems
    * {\sbf Regulace jasu:}
        \begitems \style o
        * {\sbf tlačítka 5--6:}  slouží k~postupnému zvyšování a~snižování jasu všech zapnutých světel.
        \enditems
\enditems

\medskip\noindent
Toto řešení přináší následující výhody:
\begitems
    * Menší počet tlačítek a~jednodušší typy stisknutí usnadňují pochopení a~ovládání systému.
    * Oddělení funkce zapnutí/vypnutí od regulace jasu umožňuje intuitivnější a~pohodlnější ovládání.
    % * Regulace jasu se týká všech zapnutých světel, čímž se eliminuje nutnost samostatného nastavování jasu pro každou sekci.
    * Regulace jasu ovládá všechna zapnutá světla najednou, takže není potřeba nastavovat jas pro každou sekci zvlášť.
\enditems

% Zaver
% Navrhované optimalizované ovládání světel se zaměřuje na zjednodušení a~zefektivnění obsluhy systému.
% Snížení počtu tlačítek, rozdělení funkcí a~intuitivní regulace jasu vedou
% k~pohodlnějšímu a~uživatelsky přívětivějšímu ovládání.
% Implementace tohoto řešení by tak mohla významně přispět
% ke zlepšení uživatelského komfortu a~zjednodušení ovládání světel v daném prostoru.



\sec Elektrické schéma

Elektrické schéma pro optimalizované ovládání světel je znázorněno na obrázku \ref[ovl2].
Schéma zahrnuje:
\begitems
    * Tlačítka pro zapnutí/vypnutí a regulaci jasu jsou připojena ke konektoru JP1.
    K~tlačítkům 5 a~6 jsou připojeny pull-down rezistory o hodnotě 10 kΩ,
    protože vstupní piny procesoru nemají integrované pull-down rezistory pro dané vstupy.
    * Tlačítka 1 až 4 mají invertovanou logiku, tj. při stisku se na vstupu procesoru objeví logická nula.
    * Tlačítka 5 a~6 mají neinvertovanou logiku, tj. při stisku se na vstupu procesoru objeví logická jednička.
\enditems

% Tlačítka určená pro regulaci jasu byla připojena k~pinům, které neobsahovaly pull-up rezistory.
% Proto bylo nezbytné přidat odpory o~h~dnotě 10~kΩ, aby bylo zajištěno správné fungování těchto tlačítek.



\medskip \clabel[ovl2]{Elektrické schéma}
\picw=10cm \cinspic 03_Obrazky/Ovladani/buttons.png
\caption/f Elektrické schéma tlačítek
\medskip


\sec Plošný spoj

Plošný spoj (\glref{PCB}) pro optimalizované ovládání světel je znázorněn na obrázku \ref[ovl1].
\glref{PCB} obsahuje všechny komponenty uvedené na schématu, včetně:
\begitems
    * {\sbf Napájecího konektoru:} Konektor pro připojení 5V napájení.
    * {\sbf Tlačítek:} Tlačítka pro zapnutí/vypnutí a~regulaci jasu.
    * {\sbf Pull-down rezistorů:} Rezistory 10 kΩ pro tlačítka regulace jasu.
\enditems

\noindent Rozměry desky plošného spoje jsou 91,5 x 30,5 mm.


\medskip \clabel[ovl1]{Plošný spoj}
\picw=10cm \cinspic 03_Obrazky/Ovladani/board2.png
\caption/f Plošný spoj
\medskip


\sec Řídíci jednotka

Pro řízení světel byla zvolena řídící jednotka s mikrokontrolérem \glref{ESP32} WROOM,
který se vyznačuje vysokým výkonem,
nízkým odběrem energie a~širokou škálou funkcí (viz obrázek \ref[pripojeni]).
Řídící jednotka je připojena k~plošnému spoji tlačítek pomocí konektoru JP2.
% Nabízí dostatek výpočetního výkonu pro náročné úlohy řízení světel pomocí protokolu DALI
% a zároveň umožňuje implementaci komplexních funkcí.


\medskip \clabel[pripojeni]{Řídící jednotka}
\picw=10cm \cinspic 03_Obrazky/rid_jed.jpg
\caption/f Řídící jednotka
\medskip



\sec Realizace řídicího systému

% Nově navržený panel nebylo nyní možné instalovat do učebny kvůli probíhající výuce na gymnáziu, neboť veškeré úpravy
% a~instalace ve školních prostorách probíhají mimo výukové období.
% Proto bylo veškeré zapojení provedeno a~otestováno v laboratorních podmínkách.

Montáž nově navrženého panelu do učebny musela být z technických důvodů
odložena na období mimo výuku. Důvodem je probíhající výuka na gymnáziu,
která vylučuje jakékoli úpravy a~instalace ve školních prostorách během
běžného provozu.
Z tohoto důvodu proběhlo veškeré zapojení a~testování panelu v laboratorních podmínkách.



\medskip\noindent
{\sbf Přípravné práce:}
\begitems
    * {\sbf Osazení plošného spoje tlačítek:}
        Nejprve byl plošný spoj osazen všemi součástkami, včetně rezistorů.
    * {\sbf Testování funkčnosti tlačítek:}
        Reakce řídící jednotky na stisknutí jednotlivých tlačítek byla ověřována pomocí
        testovacích programů, pro bezchybné fungování tlačítek a jejich integraci s řídicím systémem.
\enditems

\medskip\noindent
{\sbf Zapojení systému:}
\begitems
    * {\sbf Propojení světel s řídící jednotkou:} Vodiče sběrnice DALI byly připojeny k~příslušným pinům řídící jednotky.
    * {\sbf Napájení řídicí jednotky:} Napájecí zdroje 12 V byly připojeny k~napájecím konektorům řídící jednotky.
    * {\sbf Zapojení světel do zásuvky}: Světla byla zapojena do zásuvky a~napájena síťovým napětím 230 V.
\enditems



\sec Vývojové prostředí

Jako vývojové prostředí pro programování řídící jednotky bylo testováno:

\begitems
    * {\sbf PlatformIO:} PlatformIO je open-source vývojové prostředí pro vývoj softwaru pro mikrokontroléry.
        Umožňuje programování v jazycích C a~C++ a~podporuje mnoho různých mikrokontrolérů~\cite[platformio_ide].
    * {\sbf Arduino IDE:} Arduino IDE je vývojové prostředí pro programování mikrokontrolérů z platformy Arduino.
        Umožňuje programování v jazyce C++~\cite[arduino_ide].
    * {\sbf ESP--IDF (Espressif IoT Development Framework):} ESP--IDF je oficiální vývojové prostředí pro mikrokontroléry ESP32.
        Umožňuje programování v jazycích C a~C++ a~poskytuje širokou škálu funkcí pro vývoj softwaru~\cite[noauthor_esp-idf].
\enditems


Ukazuje se, že nejvhodnějším vývojovým prostředím pro programování řídící jednotky je PlatformIO,
protože je integrované do vývojového prostředí Visual Studio Code
s velmi pohodlným textovým editorem a~nabízí širokou škálu funkcí pro vývoj softwaru.
Nevýhodou je, že mnohé knihovny jsou portovány do prostředí často s výrazným zpožděním.
Popřípadě je nutné provést ruční konfiguraci knihoven, což může být značně časově náročné.

Nevýhodou Arduino IDE je v současnosti jenom omezené možnosti editoru proti Visual Studio Code.

Framework ESP--IDF je vhodný pro pokročilé uživatele, kteří potřebují využít pokročilé funkce mikrokontroléru ESP32.
Lze ho použít s libovolným textovým editorem, a integrace s Visual Studio Code je velmi dobrá.
% Pro využití všech funkcí mikrokontroléru je to nejlepší volba, ale pro jednoduché projekty to může být zbytečně složité.

Pro vývoj řídící jednotky bylo zvoleno vývojové prostředí PlatformIO, z důvodu, že byla
k dispozici jednoduchá knihovna pro komunikaci řídící jednotky se světly pomocí protokolu DALI verze 1.

% Pro případ, že by bylo nutné využít pokročilé funkce protokolu DALI verze 2, by bylo vhodné
% použít některou z knihoven pro ESP32, které jsou dostupné na internetu pro ESP--IDF.


\medskip\noindent
{\sbf Konfigurace adres:}
\begitems
    * Inicializace zařízení a adres
      byla provedena postupem uvedeným v kapitole \ref[dali_inicializace].
      Každému světlu byla přiřazena unikátní adresa v rámci komunikační sítě.
      Základní ověření funkčnosti a identifikace byla ověřena příkazem IDENTIFY.
      Při správném nastavení se zařízení rozblikalo na 10 sekund.
    * V tomto případě byla světla nastavena na adresy v rozmezí 0 až 3, čímž
        se vytvořila adresní mapa pro komunikaci mezi mikrokontrolérem a~jednotlivými světly.
\enditems


\medskip
\noindent
{\sbf Implementace scén:}
\begitems
    * Pro tlačítka byly vytvořeny scény, které definují chování světel při stisknutí daného tlačítka.
        Scény zahrnují funkce jako zapnutí/vypnutí a~snižování/zvyšování jasu.
    * Implementace scén byla provedena v programovacím prostředí pro mikrokontrolér \glref{ESP32} WROOM
        s využitím jazyka C++ a~knihoven pro komunikaci a~ovládání světel.
\enditems


% \noindent
% {\sbf Postup zapojení}
% \begitems \style o
% * zapojení světel do řídící jednotky,
% * připojit zdroj 12~V,
% * zapojení světel do zásuvky,
% * nejprve bylo zapotřebí osadit součástky na plošnou desku,
% * poté bylo zapotřebí zapojit tlačítka na řídící jednotku a~otestovat funkčnost jednotlivých tlačítek,
% * po otestování tlačítek byly přiřazeny krátké adresy jednotlivým zařízením,
% * pro kontrolu správného přiřazení slouží příkaz identify, když adresa byla správně přiřazena, zařízení se rozblikalo na 10~s,
% * v tomto případě jsou světla nastavena od 0 do 3,
% * poté následovalo vytvoření jednotlivých scén ke tlačítkům.
% \enditems

\medskip
\noindent
{\sbf Pro laboratorní účely byly nastaveny tyto scény:}
\begitems
    * Tlačítko {\sbf Off:} Slouží k~úplnému vypnutí světel.
    * Tlačítko {\sbf Výklad:} Dva světelné prvky jsou zapnuté a~dva vypnuté.
    * Tlačítko {\sbf Písemka:} Dva světelné prvky jsou nastaveny na vyšší intenzitu a~dva na nižší intenzitu.
    * Tlačítko {\sbf Denní světlo:} Každý prvek je nastaven s jinou intenzitou -- od nejnižší po nejvyšší podle vzdálenosti od oken.
    * Tlačítka {\sbf Regulace jasu:} Při krátkém nebo dlouhém stisku se intenzita postupně zvyšuje/snižuje.
\enditems

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% postup nastavování:
% * přidání jednotuvých zařízení do kupin
% * poté bylo na skupinu nastavená daná scéna
% *

%     • Nebude, žádný tam není. Jsou tam jen vypínače připojené na diming vstupy předřadníků.
%     •

%     • zapojila jsem světla do zásuvky
%     • zapojila světla do řídící jednotky
%     • a~zdroj 12~V
%     • dokumentace řídicí jednotky
%     • byla pouzit protokol DALI
%     • ridici jednotka s~\glref{ESP32}

%     • na začátku bylo zapotřebí zvolit správné piny pro ovládání světel a~tlačítek
%     • dále jsme museli nastavit adresy jednotlivým světelným zařízením - pomcí inicialize a~nebo postupným odpojováním/zapojováním
%         světel a~pomocí fce set short adress - nastavime pomoci broadcast
%     • použité fce: on, off, set max level, set min level, set systém failure level, set power on level, set fade time,
%         set fade rate, set short adress, set scene, go to scene, identify device, add to group, remove from group,
%         set operating mode
%     • dále jsme si mohli spravne nastaveni adres overit fci identify device, při spravnem nastaveni svetla zacalo
%         blikat po dobu 10s
%     • v~mem pripade mam adresy nastavene od 0-3??? overit
%     • pote jsem nastavila groupy, sceny a~dale priradila jednotlive sceny ke konkretnim tlacitkum,
%     • tlacitko off - slouzi k~uplenemu vypnuti
%     • tlacitko vyklad
%     • tlacitko pisemka
%     • tlacitko denní svetlo
%     • tlacitko regulace jasu, kdy při dlouhem stisku se intenzita zvysovala/snizovala
%     • při zmene jasu, se při stiknuti tlacitka s~konkretni scenou, vratila scena do puvodniho stavu
%     • pro budoucí implemenatci jsou sceny navrzeny dle normy viz simulace
%     • pro laboratorni ulohy, abychom navrzene zapojeni mohli overit byly zvoleny tyto scény,
%     • scena off
%     • scena vyklad, svetla prima vypla nahore zapla
%     • scena pisemnka: prima zapla, horni zapla s~mensi intenzitou
%     • scena denní svetlo, svetal s~ruznou intenzitou od nejnizsi po nejvyssi
%     • tlacitka na regulaci jasu
%     • vyvojove diagamy s~logikou tlacitek: při kazdem stisku se zapne konkretni scena, u~regulaci jasu,
%         je~pouzit cas, kde při stisku se jas zvysuje nebo snizuje
%     • zapojeni bylo v~laboratori vyzkouseno a~funguje
%     • zapojeni v~praxi nelze nyní uskutecnit, protože vsehcny instalace ve skolach probihaji mino vyukove obdobi
%     •


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \medskip
% \medskip
% \medskip
% V~učebně je momentálně instalováno dvanáct tlačítek, která způsobují potíže běžným uživatelům.
% Z~navrhovaných scén bylo vybráno implementovat tlačítko pro úplné vypnutí všech světel, tlačítko pro scénu výuky,
% písemka a~denní osvětlení. Dále jsem přidala tlačítko pro regulaci jasu, aby uživatelé měli možnost
% přizpůsobit si osvětlení podle svých preferencí v~případě výrazných změn denního světla.

% Vzhledem k~tomu, že mi nebylo umožněno změnit ovládací panel v~učebně během školního roku. Ovládací zařízení jsem navrhla
% a~zapojila v~laboratorních podmínkách. Jako řídící jednotka byla zvolena ESP3 (viz dokumentace).
% Pro zapojení byly vybrány piny podle schématu. Jedná se o~digitální porty, a~k~analogovým prvkům byly
% přidány dva odpory pro vytvoření pull-up rezistoru. Logika tlačítek byla navržena tak, že každým stiskem
% se aktivuje odpovídající scéna. U~tlačítek pro regulaci jasu je nutné stisk držet déle, aby došlo ke změně jasu.

% Postup zapojení:
% \begitems
%     * zapojila jsem světla do zásuvky
%     * zapojila světla do řídící jednotky
%     * a~zdroj 12
% V~\enditems
% \medskip
% Postup implementace
% \medskip
% Nastaveni pinu

% \medskip
% \picw=8cm \cinspic 03_Obrazky/koood.png
% % \caption/f Učebna
% \medskip

% Dale bylo zapotrebi implementovat fucnkce - prikazy

% void setup, void loop, priklad funkce, diagram logiky tlacitka

% % \sec Laboratoř



\medskip \clabel[sceny]{Realizované scény}
\picw=16cm \cinspic 03_Obrazky/sceny.png
\caption/f Realizované scény
\medskip

% Postup pro nastavování scén:

% - nastavení set failure system = 180
% - nastavení set power on = 200
% - set max level = 254
% - set min level = 85
% - set fade time
% - set rate time
% - add to group číslo zařízení číslo skupiny
% - set scene č. zařízení číslo scén hodnota jasu

\sec Nastavení scén

% Popis kroků pro nastavení scén:

\medskip\noindent
{\sbf Nastavení výchozích parametrů:}
\begitems
    * {\sbf set failure system (180):}
        Nastaví úroveň jasu světelných zařízení při výpadku řídící jednotky.
        Hodnota 180 přibližně odpovídá {70~\pcent} maximálně dosažitelného jasu.
    * {\sbf set power on (200):} Nastaví úroveň jasu při zapnutí zařízení.
        Hodnota 200 přibližně odpovídá {80~\pcent} maximálně dosažitelného jasu.
    * {\sbf set max level (254):} Nastaví maximální dosažitelný jas.
        Hodnota 254 odpovídá {100~\pcent} maximálně dosažitelného jasu.
    * {\sbf set min level (85):} Nastaví minimální dosažitelný jas.
        Hodnota 85 přibližně odpovídá {34~\pcent} maximálně dosažitelného jasu.
    * {\sbf set fade time:} Nastaví čas plynulého rozsvícení/zhasnutí při změně jasu.
       Dobu je možné vypočítat podle vzorce \ref[eq_fade_time].
      \label[eq_fade_time]
      $$ Fade\;time = 2^{({fade_{time} \over 2} -1)} \eqmark $$
      kde $fade_{time}$ je hodnota v~rozsahu 1 až 15.
      Minimální doba je 0,7~s a~maximální doba je 90,5~s (viz. tabulka~4 v~\cite[iec102]).

    * {\sbf set rate time:} Nastaví rychlost plynulé změny jasu na požadovanou úroveň.
    Rychlost je možné vypočítat podle vzorce \ref[eq_fade_rate].
    \label[eq_fade_rate]
    $$ Fade\;rate = {506 \over {2^{({fade_{rate} \over 2})}}} \eqmark $$
    kde $fade_{rate}$ je hodnota v~rozsahu 1 až 15.
    Minimální rychlost je 2,8~kroků za s a~maximální rychlost je 358~kroků za~s (viz. tabulka~5 v~\cite[iec102]).
\enditems


\medskip\medskip
\noindent
V kódu byly vytvořeny funkce pro přidání zařízení do skupin a nastavovaní scén.

\begitems
    * Funkce {\sbf  add to group (dev,grp):} Kde $dev$ je číslo zařízení a $grp$ je číslo skupiny.
        Přidá zadané zařízení do vybrané skupiny.
        To umožňuje ovládat více zařízení najednou.
    * Funkce {\sbf set scene (dev, scene, jas):}
        Nastaví úroveň jasu ($jas$) pro zadanou scénu ($scene$) a zadané zařízení
        ($dev$).
\enditems

\noindent {\sbf Popis kroků pro nastavení scén:}

\medskip\noindent
{\sbf První scéna} - dva světelné prvky byly nastavené na intenzitu jasu 200 a dva zbylé byly vypnuté

\begitems \style n
* add to group(1,1) - přidání světelného prvku s krátkou adresou 1 do groupy s číslem~1
* add to group(1,2) - přidání světelného prvku s krátkou adresou 1 do groupy s číslem~1
* set scene(-1,1,0) - nastavení světelné scény pro groupu 1 na hodnotu jasu~0 - tato funkce je volána z důvodu vymazání předešlé scény
* set scene(101,1,200) - nastavení světelné scény pro groupu 1 na hodnotu jasu~200
\enditems

obrázek volané funkce v kódu

\noindent
{\sbf Druhá scéna} - dva světelné prvky byly nastavené na vyšší intenzitu jasu 200 a dva zbylé byly na nižší 120

\noindent {\sbf Postup nastavení 2. scény:}
\begitems \style n
* set scene(0,2,200) - nastavení intenzity jasu pro zařízení s krátkou adresou~0
* set scene(1,2,120) - nastavení intenzity jasu pro zařízení s krátkou adresou~1
* set scene(2,2,200) - nastavení intenzity jasu pro zařízení s krátkou adresou~2
* set scene(3,2,120) - nastavení intenzity jasu pro zařízení s krátkou adresou~3
\enditems

\noindent U této scény nebylo zapotřebí vytvářet groupu, protože každému zařízení jsme nastavili hodnotu jasu.

\noindent
{\sbf Třetí scéna} - každý světelný prvek byl nastaven s jinou hodnotou jasu

\noindent {\sbf Postup nastavení 3. scény:}
\begitems \style n
* set scene(0,2,85) - nastavení intenzity jasu na 85 pro zařízení s krátkou adresou~0
* set scene(1,2,240) - nastavení intenzity jasu na 240 pro zařízení s krátkou adresou~1
* set scene(2,2,130) - nastavení intenzity jasu na 130 pro zařízení s krátkou adresou~2
* set scene(3,2,180) - nastavení intenzity jasu na 180 pro zařízení s krátkou adresou~3
\enditems

\noindent Nastavení tlačítka off - ukazka kodu?

\noindent Nastavení regulace jasu - ukazka kodu?


\noindent Poté je zapotřebí dopsat shrnutí:
\begitems \style o
* funguje
* komentář
* dává to smysl to tam instalovat?
* přidat obrázek ESP32 s piny

\enditems




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \sec Návrh ovládacího panelu

% Navrhla jsem ovládací panel, aby bylo jednodušší ovládání pro uživatelé.

% \medskip
% Aktuálně je v učebně ovládací panel s 12 tlačítky. Navrhla jsem 3 hlavní scény, které se budou zapínat 3 tlačítky, dále je přidáno tlačítko off na ṕlné vypnutí a~také jsem přidala tlačítko na regulaci intenzity jasu. Kdyby docházelo k~nečekaným změnám venkovního počasí.

% Tlačítko výklad, slouží k~zapnutí nepřímého osvětlení a~vypnutí první světelné řady u tabule.

% Tlačítko písemka umožňuje nasvícení místa úkonu na 500 lx, abychom dodržovali zásady normy.

% Tlačítko adaptace na denní světlo rozsvicuje řadu světel u dveří a~a postupnou změnu intezity

% \medskip
% Simulace

% \medskip
% jasova analyza